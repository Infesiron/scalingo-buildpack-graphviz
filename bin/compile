#!/usr/bin/env bash
#
# Install Grapvhiz binaries in the application slug.
#
# The installed Graphviz versions are Graphviz v2.40.1 for the Heroku-18 stack
# (Ubuntu 18.04) and Graphviz v2.38.0  for the Heroku-16 stack (Ubuntu 16.04).
#
# Notes:
#
# - Check package dependencies: apt-cache depends graphviz
# - Package websites:
#     - https://packages.ubuntu.com/bionic/graphviz (Ubuntu 18.04)
#     - http://packages.ubuntu.com/xenial/graphviz (Ubuntu 16.04)
#
# ---
#
# The 'compile' script is invoked by the slug compiler with three arguments:
#
#   $1: build_dir, location of your app directory on the build dyno
#   $2: cache_dir, directory on the build dyno that persists between builds
#   $3: env_dir, directory holding all the app's config vars as files
#
# More information here: https://devcenter.heroku.com/articles/buildpack-api
#------------------------------------------------------------------------------#

set -e

a() { sed 's/^/-----> /'; }
i() { sed 's/^/       /'; }

cd "$1"

# Debian packages for Graphviz and its dependencies. The packages are installed 
# manually instead of with APT to be able to freely chose the target directory.
case "$STACK" in
  heroku-18)
    # See https://packages.ubuntu.com/bionic/graphviz
    package_urls=(http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/graphviz_2.40.1-2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libgvc6_2.40.1-2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libcgraph6_2.40.1-2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libcdt5_2.40.1-2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libpathplan4_2.40.1-2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/graphviz/libgvpr2_2.40.1-2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/universe/g/gts/libgts-0.7-5_0.7.6+darcs121130-4_amd64.deb)
    graphviz_version="2.40.1"
    ;;
  heroku-16)
    # See https://packages.ubuntu.com/xenial/graphviz
    package_urls=(http://archive.ubuntu.com/ubuntu/pool/main/g/graphviz/graphviz_2.38.0-12ubuntu2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/g/graphviz/libcdt5_2.38.0-12ubuntu2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/g/graphviz/libcgraph6_2.38.0-12ubuntu2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/g/graphviz/libgvc6_2.38.0-12ubuntu2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/g/graphviz/libpathplan4_2.38.0-12ubuntu2_amd64.deb
http://archive.ubuntu.com/ubuntu/pool/main/g/graphviz/libgvpr2_2.38.0-12ubuntu2_amd64.deb)
    graphviz_version="2.38.0"
    ;;
  *)
    echo "Error: unknown Heroku stack: $STACK" | a
    echo "Report on https://github.com/weibeld/heroku-buildpack-graphviz/issues" | i
    exit 1
    ;;
esac
echo "Your app uses the $STACK stack" | a
echo "Will install Graphviz version $graphviz_version" | i

# Install Debian packages to custom directory in application slug
echo "Installing Debian packages:" | a
install_dir=.heroku-buildpack-graphviz
mkdir -p $install_dir
for u in "${package_urls[@]}"; do
  echo "  * ${u##*/}" | i
  curl -s "$u" >pkg.deb && dpkg -x pkg.deb "$install_dir" && rm pkg.deb
done

# Installation location of shared libraries
case "$STACK" in
  heroku-16)
    libs_dir=$install_dir/usr/lib ;;
  heroku-18)
    libs_dir=$install_dir/usr/lib/x86_64-linux-gnu ;;
esac 

# Create .profile.d script setting up PATH and LD_LIBRARY_PATH
mkdir -p .profile.d
echo "PATH=/app/$install_dir/usr/bin:\$PATH" >.profile.d/graphviz.sh
echo "export LD_LIBRARY_PATH=/app/$libs_dir:\$LD_LIBRARY_PATH" >>.profile.d/graphviz.sh

# Run dot -c to configure plugins (creates config6a file)
LD_LIBRARY_PATH=$libs_dir "$install_dir"/usr/bin/dot -c

echo "Successfully installed Graphviz $graphviz_version" | a
echo "The binaries are in /app/$install_dir/usr/bin" | i
echo
